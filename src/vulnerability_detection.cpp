/*
 * vulnerability_detection.cpp
 *
 *  Created on: Aug 18, 2016
 *      Author: root
 */

#include <fstream>
#include <string>
#include <vector>
#include <unistd.h>
#include <iostream>

#include "detection.h"
#include "Device.h"
#include "Vulnerability.h"

std::vector<Vulnerability> vul_list;

void read_vulnerability() {
	std::ifstream fin;
	std::string line;

	Vulnerability vul;

	bool flag = false;

	fin.open("vulner.db");

	while (std::getline(fin, line)) {
		if (line[0] == 'i') {
			std::string id;

			if (flag) vul_list.push_back(vul);

			vul = Vulnerability();
			id = line.substr(4);

			vul.set_id(id);

			flag = true;

		} else if (line[0] == 's') {
			std::string score = line.substr(7);
			vul.set_score(score);

		} else if (line[0] == 't') {
			std::string target = line.substr(8);
			vul.add_target(target);

		} else {

		}
	}
	/*
	std::vector<Vulnerability>::iterator iter;

	for (iter = vul_list.begin(); iter != vul_list.end(); iter++) {
		std::cout << "id: " << iter->get_id() << std::endl;
		std::cout << "score: " << iter->get_score() << std::endl;

		std::set<std::string>::iterator v_iter;

		for (v_iter = iter->get_targets().begin(); v_iter != iter->get_targets().end(); v_iter++) {
			std::cout << *v_iter << std::endl;
		}
	}
	*/
}

void detect_velnerability(Device &_dev) {
	std::vector<Vulnerability>::iterator vul_iter;
	std::string os = _dev.get_os();

	for (vul_iter = vul_list.begin(); vul_iter != vul_list.end(); vul_iter++) {
		if (vul_iter->isIn(os))
			_dev.add_vulnerability(*vul_iter);
	}
}
