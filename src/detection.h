/*
 * detection.h
 *
 *  Created on: Aug 5, 2016
 *      Author: root
 */

#ifndef DETECTION_H_
#define DETECTION_H_

#include <libndpi-1.8.0/libndpi/ndpi_main.h>
#include <pcap.h>
#include "Device.h"

struct ipv6_hdr {
	unsigned long ver_tos_flow;
	unsigned short pay_len;
	u_char proto;
	u_char ttl;
	u_char src[16];
	u_char dst[16];
};

// ip version constant
#define IP_VER4 0x04
#define IP_VER6 0x06

// winow size constant
#define WIN_TYPE_ANY	0x01
#define WIN_TYPE_MOD	0x02
#define WIN_TYPE_MSS	0x03
#define WIN_TYPE_MTU	0x04
#define WIN_TYPE_NORMAL 0x00

// option layout constant
#define MAX_TCP_OPT	  24
#define TCPOPT_EOL	  0

/* TCP flags */

#define TCP_FIN				0x01
#define TCP_SYN				0x02
#define TCP_RST				0x04
#define TCP_PUSH			0x08
#define TCP_ACK				0x10
#define TCP_URG				0x20

/* TCP options */

#define TCPOPT_EOL			0x0
#define TCPOPT_NOP			0x1
#define TCPOPT_MAXSEG		0x2
#define TCPOPT_WSCALE		0x3
#define TCPOPT_SACKOK		0x4
#define TCPOPT_SACK			0x5
#define TCPOPT_TSTAMP		0x8

/* IP-level quirks: */

#define QUIRK_ECN            0x00000001 /* ECN supported                      */
#define QUIRK_DF             0x00000002 /* DF used (probably PMTUD)           */
#define QUIRK_NZ_ID          0x00000004 /* Non-zero IDs when DF set           */
#define QUIRK_ZERO_ID        0x00000008 /* Zero IDs when DF not set           */
#define QUIRK_NZ_MBZ         0x00000010 /* IP "must be zero" field isn't      */
#define QUIRK_FLOW           0x00000020 /* IPv6 flows used                    */

/* Core TCP quirks: */

#define QUIRK_ZERO_SEQ       0x00001000 /* SEQ is zero                        */
#define QUIRK_NZ_ACK         0x00002000 /* ACK non-zero when ACK flag not set */
#define QUIRK_ZERO_ACK       0x00004000 /* ACK is zero when ACK flag set      */
#define QUIRK_NZ_URG         0x00008000 /* URG non-zero when URG flag not set */
#define QUIRK_URG            0x00010000 /* URG flag set                       */
#define QUIRK_PUSH           0x00020000 /* PUSH flag on a control packet      */

/* TCP option quirks: */

#define QUIRK_OPT_ZERO_TS   0x01000000 /* Own timestamp set to zero          */
#define QUIRK_OPT_NZ_TS2     0x02000000 /* Peer timestamp non-zero on SYN     */
#define QUIRK_OPT_EOL_NZ     0x04000000 /* Non-zero padding past EOL          */
#define QUIRK_OPT_EXWS       0x08000000 /* Excessive window scaling           */
#define QUIRK_OPT_BAD        0x10000000 /* Problem parsing TCP options        */

struct os_detect_data{
	u_char ip_v;
	u_char tcp_type;

	unsigned long s_addr;
	unsigned long d_addr;

	unsigned short s_port;
	unsigned short d_port;

	u_char ttl;
	u_char tos;

	unsigned short mss;
	unsigned short win;
	u_char wscale;
	unsigned short tot_hdr;

	u_char o_layout[24];
	u_char o_cnt;
	u_char o_eol_pad;

	unsigned long ts;

	unsigned long quirks;

	u_char ip_opt_len;

	u_char *payload;
	unsigned short pay_len;

	unsigned long seq;
};

struct sub_container {
	pcap_pkthdr *header;
	u_char *packet;
	ndpi_iphdr *iph;
	ndpi_ipv6hdr *iph6;
	unsigned long packet_len;
	ndpi_protocol *protocol;
};

/* for os detection */
#define WINDOWS_FAMILY 	0x1
#define LINUX_FAMILY	0x2
#define UNIX_FAMILY		0x3

#define UNKNOWN_FAMILY	0x5


void protocol_detection_init(pcap_t *);
void run_protocol_detection();
void stop_protocol_detection();

void init_os_detection();
void run_os_detection();
void stop_os_detection();

void read_vulnerability();
void detect_velnerability(Device &);


#endif /* DETECTION_H_ */
