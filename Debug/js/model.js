
var GraphModel = Backbone.Model.extend({
        defaults: {

            nodes: [],
            relations: [],
            centerId: -1,
            distance: 1
        },

        initialize: function () {
            var nodes = this.get("nodes");
            var relations = this.get("relations");

            this.nodeCollection = new NodeCollection();

            var indexMapping = d3.map();

            for (var i = 0; i < nodes.length; i++) {
                var n = new Node({vulner: nodes[i].vulner, layer: nodes[i].layer, name: nodes[i].name, id: nodes[i].id, score: nodes[i].score});
                var lValue = nodes[i].layer;
                if (lValue == 1) {
                    n.set("color", "#2A0066");
                }
                else if (lValue == 2) {
                    n.set("color", "#003399");
                }
                else if (lValue == 3) {
                    n.set("color", "#2F9D27");
                }
                else if (lValue == 4) {
                    n.set("color", "#008299");
                }
                
                for (var ind = 0; ind < n.get("score").length; ind++) {
                    if (n.get("score")[ind] >= 6 && n.get("layer") > 1) {
                        n.set("color", "red");
                    }
                }
                
                this.nodeCollection.add(n);
                indexMapping.set(nodes[i].id, n);
            //    console.log(nodes[i].id, n);
            }

            for (var i = 0; i < relations.length; i++) {
                var nodeA = indexMapping.get(relations[i][0]);
                var nodeB = indexMapping.get(relations[i][1]);

                nodeA.addNeighbor(nodeB);
                nodeB.addNeighbor(nodeA);
            }

        },
        
        getNodeCollection: function() {
            return this.nodeCollection.models;
        },

        fetch: function (id, distance) {
            console.log("fetch", id, distance);
            this.centerId = id;
            this.distance = distance;

            n = this.nodeCollection.get(id);

            this.subNodeCollection = this.getNeighborhood(n, distance);

            this.trigger("changes",n,this.subNodeCollection.models);

        },

        distanceChange: function(distance) {
            console.log("distanceChange",distance);
            this.distance = distance;
           this.fetch(this.centerId,distance);
        },
    
        getInformation: function(d, distance) {
            var information = [];
            neighborhood = new NodeCollection();

            borderNodes = d3.map();
            
            var center = this.nodeCollection.get(d.id);

            jobs = [
                {node: center, depth: 0}
            ];
            
	       if (d.layer > 2) {
                for (var ind = 0; ind < d.vulnerable.length; ind++) {
                    var info = "<table><tr><td width=\"300px\">"
                    info += d.vulnerable[ind];
                    info += "</td><td width=\"100px\">";
                    info += d.score[ind];
                    info += "</td></tr></table>"
                    information.push(info);
                }
            }
                

            neighborhood.add(center);

            while (jobs.length > 0) {
                job = jobs.shift();

                if (job.depth < distance) {
                    nh = job.node.getNeighborhood();

                    for (var i = 0; i < nh.length; i++) {
                        var nodeB = nh.at(i);
                        if (neighborhood.get(nodeB.id) == undefined && nodeB.get("layer") > d.layer) {
                            neighborhood.add(nodeB);
                            jobs.push({node: nodeB, depth: job.depth + 1});
                            if (nodeB.get("layer") == 3) {
                                for (var ind = 0; ind < nodeB.get("vulner").length; ind++) {
                                    var info = "<table><tr><td width=\"300px\">"
                                    info += nodeB.get("vulner")[ind];
                                    info += "</td><td width=\"100px\">";
                                    info += nodeB.get("score")[ind];
                                    info += "</td></tr></table>"
                                    information.push(info);
                                }
                            }
                        }

                    }

                }

            }


            return information;
        },

        getNeighborhood: function (center, distance) {
            console.log("getNeighborhood", center);
            neighborhood = new NodeCollection();

            borderNodes = d3.map();

            jobs = [
                {node: center, depth: 0}
            ];

            neighborhood.add(center);

            while (jobs.length > 0) {
                job = jobs.shift();

                if (job.depth < distance) {
                    nh = job.node.getNeighborhood();

                    for (var i = 0; i < nh.length; i++) {
                        var nodeB = nh.at(i);
                        if (neighborhood.get(nodeB.id) == undefined) {

                            neighborhood.add(nodeB);
                            jobs.push({node: nodeB, depth: job.depth + 1});
                        }

                    }

                }

            }


            return neighborhood;

        }

    })
    ;

var Node = Backbone.Model.extend({

    idAttribute: "id",

    defaults: {

    },
    initialize: function () {
        this.neighborhood = new NodeCollection();
       // this.set("color", "#ABCDEF");
    },

    addNeighbor: function (n) {
        //  console.log("addNeighbour");
        this.neighborhood.add(n);
    },

    removeNeighbor: function (n) {
        //  console.log("removeNeighbour");
        this.neighborhood.remove(n);
    },

    getNeighborhood: function () {
        //  console.log("getNeighborhood");
        return this.neighborhood;
    },

    setNeighborhood: function (nh) {
        //  console.log("getNeighborhood");
        this.neighborhood = nh;
    }

});

var NodeCollection = Backbone.Collection.extend({

    model: Node

});

function randomBlue() {

    var allowed = "456789ABCDE", S = "#AAAA";

    while (S.length < 7) {
        S += allowed.charAt(Math.floor((Math.random() * 16) + 1));
    }
    return S;
}


