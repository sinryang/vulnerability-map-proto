$(function() {
	var prev = 0;
	var curr = 0;
	var flag = 1;
	var view_all = 1;
	
	
        $.getJSON('myflag.json', function(flag_data) {
            curr = flag_data.flag;
            
            if (curr != prev) {
                flag = 1;
            }
			
			if (flag == 1) {
				$("#graph").empty();
				$.getJSON('js/../data.json', function(data) {
					var nodes = [];
		
					var i = 0;
					while (data.nodes[i]) {
						//console.log("data.nodes[" + i + "].name: " + data.nodes[i].name);
						nodes.push({id: data.nodes[i].id, layer: data.nodes[i].layer, name: data.nodes[i].name, vulner: data.nodes[i].vulner, score: data.nodes[i].score});
						i++;
					}
		
					var relations = [];
    
					i = 0;
					while (data.links[i]) {
						relations.push([data.links[i].source, data.links[i].target]);
						i++;
					}

					var graphModel = new GraphModel({
						nodes: nodes,
						relations: relations
					});

					var graphView = new GraphView({
						model: graphModel
					});

					var info = "[ Vulnerability List ]<br/><hr class=\"container_line\">선택한 노드의 취약성 정보를 보여줍니다.<br/>";

                                        viewGraph = function() {
					    if (view_all) {
						viewAll();
						view_all = 0;
					    }
					    else {
						viewHome();
						view_all = 1;
					    }
					}
	
					viewHome = function() {
						$(".button").html("<span>Show All </span>");
						$(".vulner_container").html(info);
						graphModel.fetch(0, 1);
						view_all = 1;
					}
					
					viewAll = function() {
						if (view_all) {
							$(".button").html("<span>Home </span>");
							$(".vulner_container").html(info);
							graphModel.fetch(0, 3);
							view_all = 0;
						}
						else {
							$(".button").html("<span>Show All </span>");
							$(".vulner_container").html(info);
							graphModel.fetch(0, 1);
							view_all = 1;
						}
					}

    				graphModel.fetch(0,1);
				
				});
			}
            
            prev = curr;
			flag = 0;
        });
    
});

function ReadFile(fileName) {
    var xmlHttp = new XMLHttpRequest(); 
    xmlHttp.open("GET", fileName, true);
    var input = xmlHttp.responseText;
    xmlHttp.send(null);
    
    return input;
}
